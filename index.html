<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bidd Sports</title>
    <!-- Link to the Web App Manifest -->
    <link rel="manifest" href="manifest.json">
    <!-- Theme color for the browser address bar -->
    <meta name="theme-color" content="#4f46e5">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.autotable.min.js" onload="window.pdfLibrariesLoaded = true;"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
        .modal:not([open]) {
            pointer-events: none;
            opacity: 0;
        }
        .modal:not([open]) .modal-content {
            transform: scale(0.95);
        }
        .loader {
            border-top-color: #4f46e5; /* indigo-600 */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        .tab-active {
            border-color: #4f46e5;
            color: #4f46e5;
            background-color: #eef2ff;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <!-- 
      Tailwind CSS Safelist:
      This hidden block contains all the dynamically generated color classes for the house themes.
      It ensures that Tailwind's JIT compiler includes these styles in the final CSS.
    -->
    <div class="hidden">
        <span class="bg-yellow-400"></span>
        <span class="bg-green-400"></span>
        <span class="bg-red-400"></span>
        <span class="bg-blue-400"></span>
    </div>

    <!-- Main Application Container -->
    <div id="app" class="container mx-auto p-4 md:p-6 max-w-7xl">

        <!-- Header -->
        <header class="flex items-center justify-between gap-4 md:gap-6 mb-6 md:mb-8">
            <div class="flex items-center gap-4 md:gap-6">
                 <div class="p-2 bg-white rounded-lg shadow-md">
                    <img id="schoolLogo" src="HurunuiCollegeLogoRefresh-07%20large.png" alt="School Logo" class="w-20 h-20 md:w-24 md:h-24 object-contain">
                </div>
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Bidd Sports</h1>
                    <p class="text-slate-600 mt-1">Your official tool for managing sports competitions.</p>
                </div>
            </div>
        </header>

        <!-- Loading State -->
        <div id="loading" class="flex flex-col justify-center items-center py-20">
            <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24"></div>
            <p id="loading-message" class="mt-4 text-slate-600 text-center">Connecting to database...</p>
        </div>
        
        <!-- Main Content (Hidden until loaded) -->
        <main id="mainContent" class="hidden">

             <!-- Meets View -->
            <div id="meetsView">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-slate-800">Competitions</h2>
                    <button id="addMeetBtn" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-indigo-700 transition duration-200">
                        + Add Competition
                    </button>
                </div>
                 <p class="text-slate-500 mb-4 -mt-2">Select a competition to view its events or create a new one.</p>
                <div id="meetsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Meet cards will be inserted here -->
                </div>
                 <div id="noMeetsMessage" class="hidden text-center py-16 bg-white rounded-lg shadow-sm">
                    <h3 class="text-xl font-medium text-slate-700">No competitions yet!</h3>
                    <p class="text-slate-500 mt-2">Click the "+ Add Competition" button to get started.</p>
                </div>
            </div>
            
            <!-- Events View -->
            <div id="eventsView" class="hidden">
                 <div class="mb-4">
                     <button id="backToMeetsBtn" class="text-indigo-600 hover:text-indigo-800 font-medium transition duration-200">
                        &larr; Back to Competitions
                    </button>
                </div>
                <div id="housePointsContainer" class="mb-8 bg-white p-6 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-2">
                        <h2 id="housePointsTitle" class="text-2xl font-semibold text-slate-800">Team Points</h2>
                        <button id="printHousePointsBtn" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                            Loading...
                        </button>
                    </div>
                     <p class="text-sm text-slate-500 mb-4">Placing: 1st (5), 2nd (3), 3rd (1). Participation: 1 point per participant with a result or checkbox ticked.</p>
                    <ol id="housePointsList" class="space-y-4">
                        <!-- House points will be dynamically inserted here -->
                    </ol>
                </div>

                <div class="flex justify-between items-center mb-4">
                    <h2 id="eventsTitle" class="text-2xl font-semibold text-slate-800">Events</h2>
                    <div class="flex gap-2">
                         <button id="shareLinkBtn" class="bg-gray-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-gray-700 transition duration-200">
                            Share Sign-up Link
                        </button>
                        <button id="addEventBtn" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-indigo-700 transition duration-200">
                            + Add Event
                        </button>
                    </div>
                </div>
                 <p class="text-slate-500 mb-4 -mt-2">Click on an event to view results, or add a new event for this competition.</p>
                <div id="eventsContainer" class="space-y-6">
                    <!-- Event groups will be inserted here -->
                </div>
                 <div id="noEventsMessage" class="hidden text-center py-16 bg-white rounded-lg shadow-sm">
                    <h3 class="text-xl font-medium text-slate-700">No events yet!</h3>
                    <p class="text-slate-500 mt-2">Click the "+ Add Event" button to get started.</p>
                </div>
            </div>

            <!-- Results View (Initially hidden) -->
            <div id="resultsView" class="hidden">
                <div class="mb-4">
                     <button id="backToEventsBtn" class="text-indigo-600 hover:text-indigo-800 font-medium transition duration-200">
                        &larr; Back to Events
                    </button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <div class="flex flex-col md:flex-row justify-between md:items-center mb-4 gap-4">
                        <div>
                            <h2 id="resultsEventName" class="text-3xl font-bold text-slate-900"></h2>
                            <div class="text-slate-500 space-y-1 mt-1">
                                <p id="resultsEventInfo"></p>
                                <p id="resultsMaleRecordInfo"></p>
                                <p id="resultsFemaleRecordInfo"></p>
                            </div>
                        </div>
                        <div class="flex gap-2 flex-wrap justify-end">
                             <button id="printQualifiersBtn" class="bg-green-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-green-700 transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                                Loading...
                            </button>
                             <button id="printResultsBtn" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                                Loading...
                            </button>
                            <input type="file" id="csvFileInput" class="hidden" accept=".csv">
                            <button id="uploadCsvBtn" class="bg-gray-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-gray-700 transition duration-200">
                                Upload CSV
                            </button>
                            <button id="addParticipantBtn" class="bg-teal-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-teal-700 transition duration-200">
                                + Add Participant
                            </button>
                        </div>
                    </div>
                     <p class="text-slate-500 mb-4 -mt-2">Add participants, edit results, or manage participant details.</p>
                    
                    <!-- Gender Tabs -->
                    <div class="border-b border-gray-200 mb-4">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <button id="maleTab" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Male</button>
                            <button id="femaleTab" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Female</button>
                        </nav>
                    </div>

                    <div id="resultsContainer" class="overflow-x-auto">
                        <table class="w-full text-left min-w-[600px]">
                            <thead class="bg-slate-50 border-b border-slate-200">
                                <tr>
                                    <th class="p-3 font-semibold text-sm text-slate-600">Placing</th>
                                    <th class="p-3 font-semibold text-sm">
                                        <button id="sortByNameBtn" class="flex items-center gap-1 text-slate-600 hover:text-indigo-600 transition-colors">
                                            Participant Name
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                              <path stroke-linecap="round" stroke-linejoin="round" d="M7 16V4m0 12l-4-4m4 4l4-4m6-4v12m0-12l4 4m-4-4l-4 4" />
                                            </svg>
                                        </button>
                                    </th>
                                    <th class="p-3 font-semibold text-sm text-slate-600">Team/House</th>
                                    <th class="p-3 font-semibold text-sm text-slate-600">Participated</th>
                                    <th class="p-3 font-semibold text-sm text-slate-600">Result</th>
                                    <th class="p-3 font-semibold text-sm text-slate-600">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="resultsTableBody">
                                <!-- Results will be inserted here -->
                            </tbody>
                        </table>
                        <div id="noParticipantsMessage" class="hidden text-center py-12">
                            <p class="text-slate-500">No participants have been added for this gender.</p>
                        </div>
                    </div>
                </div>
                 <div class="mt-6 flex justify-end">
                        <button id="deleteEventBtn" class="bg-red-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-red-700 transition duration-200">
                           Delete Event
                        </button>
                    </div>
            </div>
            
        </main>
        
        <!-- Public Sign-up View -->
        <div id="signupView" class="hidden">
            <h2 id="signupCompetitionName" class="text-3xl font-bold text-slate-900 mb-2"></h2>
            <p class="text-slate-500 mb-6">Select an event to sign up for.</p>
            <div id="signupEventsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Sign-up event cards will be inserted here -->
            </div>
             <div id="noSignupEventsMessage" class="hidden text-center py-16 bg-white rounded-lg shadow-sm">
                <h3 class="text-xl font-medium text-slate-700">No events available for sign-up.</h3>
                <p class="text-slate-500 mt-2">Please check back later or contact the event organizer.</p>
            </div>
        </div>

    </div>

    <!-- Modals -->
    <dialog id="addMeetModal" class="modal p-0 rounded-lg shadow-xl max-w-md w-full">
        <div class="modal-content bg-white p-6 rounded-lg">
            <h3 class="text-xl font-bold mb-4">Add New Competition</h3>
            <form id="addMeetForm">
                <div class="mb-4">
                    <label for="meetName" class="block text-sm font-medium text-slate-700">Competition Name</label>
                    <input type="text" id="meetName" name="meetName" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm" placeholder="e.g., Annual Sports Day 2025" required>
                </div>
                <div class="mb-6">
                    <label for="ageGroups" class="block text-sm font-medium text-slate-700">Age Groups (one per line)</label>
                    <textarea id="ageGroups" name="ageGroups" rows="4" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm" placeholder="U10&#10;U12&#10;U14&#10;Senior"></textarea>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" class="cancel-btn bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 transition">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Create Competition</button>
                </div>
            </form>
        </div>
    </dialog>

    <dialog id="editMeetModal" class="modal p-0 rounded-lg shadow-xl max-w-md w-full">
        <div class="modal-content bg-white p-6 rounded-lg">
            <h3 class="text-xl font-bold mb-4">Edit Competition</h3>
            <form id="editMeetForm">
                <input type="hidden" id="editMeetId" name="meetId">
                <div class="mb-4">
                    <label for="editMeetName" class="block text-sm font-medium text-slate-700">Competition Name</label>
                    <input type="text" id="editMeetName" name="meetName" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm" required>
                </div>
                <div class="mb-6">
                    <label for="editAgeGroups" class="block text-sm font-medium text-slate-700">Age Groups (one per line)</label>
                    <textarea id="editAgeGroups" name="ageGroups" rows="4" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm"></textarea>
                </div>
                <div class="flex justify-between items-center">
                    <button type="button" id="deleteMeetBtn" class="bg-red-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-red-700 transition">Delete</button>
                    <div class="flex gap-3">
                        <button type="button" class="cancel-btn bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 transition">Cancel</button>
                        <button type="submit" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Save Changes</button>
                    </div>
                </div>
            </form>
        </div>
    </dialog>

    <dialog id="addEventModal" class="modal p-0 rounded-lg shadow-xl max-w-md w-full">
        <div class="modal-content bg-white p-6 rounded-lg">
            <h3 class="text-xl font-bold mb-4">Add New Event</h3>
            <form id="addEventForm">
                <div class="mb-4">
                    <label for="eventName" class="block text-sm font-medium text-slate-700">Event Name</label>
                    <input type="text" id="eventName" name="eventName" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm" placeholder="e.g., 100m Sprint" required>
                </div>
                <div class="mb-4">
                    <label for="eventType" class="block text-sm font-medium text-slate-700">Event Type</label>
                    <select id="eventType" name="eventType" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm" required>
                        <option value="Time">Time (Lowest score wins)</option>
                        <option value="Distance">Distance (Highest score wins)</option>
                        <option value="Points">Points (Highest score wins)</option>
                    </select>
                </div>
                 <div class="mb-4">
                    <label for="ageGroup" class="block text-sm font-medium text-slate-700">Age Group</label>
                    <select id="ageGroup" name="ageGroup" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm" required>
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                 <div class="mb-4">
                    <label for="eventUnits" class="block text-sm font-medium text-slate-700">Units</label>
                    <input type="text" id="eventUnits" name="eventUnits" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm" placeholder="e.g., s, m, points" required>
                </div>
                
                <div class="space-y-4 mb-6">
                    <div>
                        <h4 class="font-medium text-slate-800">Male Record (Optional)</h4>
                         <div class="grid grid-cols-3 gap-4 mt-2">
                            <div class="col-span-1">
                                <label for="maleEventRecord" class="block text-sm text-slate-600">Record</label>
                                <input type="number" step="any" id="maleEventRecord" name="maleEventRecord" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm">
                            </div>
                            <div class="col-span-2">
                                <label for="maleRecordHolder" class="block text-sm text-slate-600">Holder</label>
                                <input type="text" id="maleRecordHolder" name="maleRecordHolder" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm">
                            </div>
                            <div class="col-span-1">
                                <label for="maleRecordYear" class="block text-sm text-slate-600">Year</label>
                                <input type="number" id="maleRecordYear" name="maleRecordYear" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm">
                            </div>
                        </div>
                    </div>
                     <div>
                        <h4 class="font-medium text-slate-800">Female Record (Optional)</h4>
                         <div class="grid grid-cols-3 gap-4 mt-2">
                            <div class="col-span-1">
                                <label for="femaleEventRecord" class="block text-sm text-slate-600">Record</label>
                                <input type="number" step="any" id="femaleEventRecord" name="femaleEventRecord" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm">
                            </div>
                            <div class="col-span-2">
                                <label for="femaleRecordHolder" class="block text-sm text-slate-600">Holder</label>
                                <input type="text" id="femaleRecordHolder" name="femaleRecordHolder" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm">
                            </div>
                            <div class="col-span-1">
                                 <label for="femaleRecordYear" class="block text-sm text-slate-600">Year</label>
                                <input type="number" id="femaleRecordYear" name="femaleRecordYear" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end gap-3">
                    <button type="button" class="cancel-btn bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 transition">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Create Event</button>
                </div>
            </form>
        </div>
    </dialog>
    
    <dialog id="editEventModal" class="modal p-0 rounded-lg shadow-xl max-w-md w-full">
        <div class="modal-content bg-white p-6 rounded-lg">
            <h3 class="text-xl font-bold mb-4">Edit Event</h3>
            <form id="editEventForm">
                 <input type="hidden" id="editEventId" name="eventId">
                <div class="mb-4">
                    <label for="editEventName" class="block text-sm font-medium text-slate-700">Event Name</label>
                    <input type="text" id="editEventName" name="eventName" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm" required>
                </div>
                <div class="mb-4">
                    <label for="editEventType" class="block text-sm font-medium text-slate-700">Event Type</label>
                    <select id="editEventType" name="eventType" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm" required>
                        <option value="Time">Time (Lowest score wins)</option>
                        <option value="Distance">Distance (Highest score wins)</option>
                        <option value="Points">Points (Highest score wins)</option>
                    </select>
                </div>
                 <div class="mb-4">
                    <label for="editAgeGroup" class="block text-sm font-medium text-slate-700">Age Group</label>
                    <select id="editAgeGroup" name="ageGroup" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm" required>
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                 <div class="mb-4">
                    <label for="editEventUnits" class="block text-sm font-medium text-slate-700">Units</label>
                    <input type="text" id="editEventUnits" name="eventUnits" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm" required>
                </div>
                
                <div class="space-y-4 mb-6">
                    <div>
                        <h4 class="font-medium text-slate-800">Male Record (Optional)</h4>
                         <div class="grid grid-cols-3 gap-4 mt-2">
                            <div class="col-span-1">
                                <label for="editMaleEventRecord" class="block text-sm text-slate-600">Record</label>
                                <input type="number" step="any" id="editMaleEventRecord" name="maleEventRecord" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm">
                            </div>
                            <div class="col-span-2">
                                <label for="editMaleRecordHolder" class="block text-sm text-slate-600">Holder</label>
                                <input type="text" id="editMaleRecordHolder" name="maleRecordHolder" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm">
                            </div>
                            <div class="col-span-1">
                                <label for="editMaleRecordYear" class="block text-sm text-slate-600">Year</label>
                                <input type="number" id="editMaleRecordYear" name="maleRecordYear" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm">
                            </div>
                        </div>
                    </div>
                     <div>
                        <h4 class="font-medium text-slate-800">Female Record (Optional)</h4>
                         <div class="grid grid-cols-3 gap-4 mt-2">
                            <div class="col-span-1">
                                <label for="editFemaleEventRecord" class="block text-sm text-slate-600">Record</label>
                                <input type="number" step="any" id="editFemaleEventRecord" name="femaleEventRecord" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm">
                            </div>
                            <div class="col-span-2">
                                <label for="editFemaleRecordHolder" class="block text-sm text-slate-600">Holder</label>
                                <input type="text" id="editFemaleRecordHolder" name="femaleRecordHolder" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm">
                            </div>
                            <div class="col-span-1">
                                 <label for="editFemaleRecordYear" class="block text-sm text-slate-600">Year</label>
                                <input type="number" id="editFemaleRecordYear" name="femaleRecordYear" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end gap-3">
                    <button type="button" class="cancel-btn bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 transition">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Save Changes</button>
                </div>
            </form>
        </div>
    </dialog>

    <dialog id="addParticipantModal" class="modal p-0 rounded-lg shadow-xl max-w-md w-full">
        <div class="modal-content bg-white p-6 rounded-lg">
            <h3 class="text-xl font-bold mb-4">Add Participant</h3>
            <form id="addParticipantForm">
                <div class="mb-4">
                    <label for="athleteName" class="block text-sm font-medium text-slate-700">Participant Name</label>
                    <input type="text" id="athleteName" name="athleteName" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm" required>
                </div>
                <div class="mb-4">
                    <label for="gender" class="block text-sm font-medium text-slate-700">Gender</label>
                    <select id="gender" name="gender" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm" required>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label for="houseGroup" class="block text-sm font-medium text-slate-700">Team / House</label>
                    <select id="houseGroup" name="houseGroup" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm" required>
                        <option value="Mason">Mason</option>
                        <option value="Sheppard">Sheppard</option>
                        <option value="Sumner">Sumner</option>
                        <option value="Taylor">Taylor</option>
                    </select>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" class="cancel-btn bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 transition">Cancel</button>
                    <button type="submit" class="bg-teal-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-teal-700 transition">Add Participant</button>
                </div>
            </form>
        </div>
    </dialog>

    <dialog id="editParticipantModal" class="modal p-0 rounded-lg shadow-xl max-w-md w-full">
        <div class="modal-content bg-white p-6 rounded-lg">
            <h3 class="text-xl font-bold mb-4">Edit Participant</h3>
            <form id="editParticipantForm">
                <input type="hidden" id="editParticipantId" name="participantId">
                <div class="mb-4">
                    <label for="editAthleteName" class="block text-sm font-medium text-slate-700">Participant Name</label>
                    <input type="text" id="editAthleteName" name="athleteName" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm" required>
                </div>
                <div class="mb-4">
                    <label for="editGender" class="block text-sm font-medium text-slate-700">Gender</label>
                    <select id="editGender" name="gender" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm" required>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label for="editHouseGroup" class="block text-sm font-medium text-slate-700">Team / House</label>
                    <select id="editHouseGroup" name="houseGroup" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm" required>
                        <option value="Mason">Mason</option>
                        <option value="Sheppard">Sheppard</option>
                        <option value="Sumner">Sumner</option>
                        <option value="Taylor">Taylor</option>
                    </select>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" class="cancel-btn bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 transition">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Save Changes</button>
                </div>
            </form>
        </div>
    </dialog>
    
    <dialog id="editResultModal" class="modal p-0 rounded-lg shadow-xl max-w-md w-full">
        <div class="modal-content bg-white p-6 rounded-lg">
            <h3 class="text-xl font-bold mb-4">Enter Result</h3>
            <p class="mb-4">Entering result for <strong id="editResultAthleteName"></strong>.</p>
            <form id="editResultForm">
                <input type="hidden" id="editResultParticipantId" name="participantId">
                <div class="mb-6">
                    <label for="resultValue" class="block text-sm font-medium text-slate-700">Result</label>
                    <input type="number" step="any" id="resultValue" name="resultValue" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm" required>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" class="cancel-btn bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 transition">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Save Result</button>
                </div>
            </form>
        </div>
    </dialog>

    <dialog id="csvUploadModal" class="modal p-0 rounded-lg shadow-xl max-w-2xl w-full">
        <div class="modal-content bg-white p-6 rounded-lg">
            <h3 class="text-xl font-bold mb-4">Import Participants from CSV</h3>
            <p class="text-slate-600 mb-4">Map the columns from your CSV file to the required fields. Participants will be added to all events that match their Age Group.</p>
            <div id="csvMapping" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="csvFirstName" class="block text-sm font-medium text-slate-700">First Name Column</label>
                    <select id="csvFirstName" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm"></select>
                </div>
                <div>
                    <label for="csvSurname" class="block text-sm font-medium text-slate-700">Surname Column</label>
                    <select id="csvSurname" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm"></select>
                </div>
                 <div>
                    <label for="csvGender" class="block text-sm font-medium text-slate-700">Gender Column</label>
                    <select id="csvGender" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm"></select>
                </div>
                <div>
                    <label for="csvAgeGroup" class="block text-sm font-medium text-slate-700">Age Group Column</label>
                    <select id="csvAgeGroup" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm"></select>
                </div>
                <div>
                    <label for="csvHouseGroup" class="block text-sm font-medium text-slate-700">Team / House Column</label>
                    <select id="csvHouseGroup" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm"></select>
                </div>
            </div>
            <p class="text-sm font-medium text-slate-700 mb-2">Data Preview (first 5 rows)</p>
            <div class="overflow-x-auto border rounded-lg">
                <table class="w-full text-left">
                    <thead id="csvPreviewHead" class="bg-slate-50"></thead>
                    <tbody id="csvPreviewBody"></tbody>
                </table>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button type="button" class="cancel-btn bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 transition">Cancel</button>
                <button type="button" id="confirmCsvImport" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Confirm & Import</button>
            </div>
        </div>
    </dialog>

    <dialog id="deleteConfirmModal" class="modal p-0 rounded-lg shadow-xl max-w-sm w-full">
        <div class="modal-content bg-white p-6 rounded-lg">
            <h3 class="text-xl font-bold mb-2">Are you sure?</h3>
            <p id="deleteConfirmText" class="text-slate-600 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end gap-3">
                <button type="button" class="cancel-btn bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 transition">Cancel</button>
                <button id="confirmDeleteBtn" class="bg-red-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-red-700 transition">Delete</button>
            </div>
        </div>
    </dialog>
    
    <dialog id="shareLinkModal" class="modal p-0 rounded-lg shadow-xl max-w-lg w-full">
        <div class="modal-content bg-white p-6 rounded-lg">
            <h3 class="text-xl font-bold mb-4">Share Link</h3>
            <p id="shareLinkDescription" class="text-slate-600 mb-4"></p>
            <input type="text" id="shareableLink" readonly class="w-full p-2 border rounded-md bg-slate-100">
            <div class="flex justify-end gap-3 mt-4">
                <button id="copyLinkBtn" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Copy Link</button>
                <button type="button" class="cancel-btn bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 transition">Close</button>
            </div>
        </div>
    </dialog>

     <dialog id="publicSignupModal" class="modal p-0 rounded-lg shadow-xl max-w-md w-full">
        <div class="modal-content bg-white p-6 rounded-lg">
            <div id="signupFormContainer">
                <h3 id="signupEventName" class="text-xl font-bold mb-4">Sign Up</h3>
                <form id="publicSignupForm">
                    <input type="hidden" id="signupEventId" name="eventId">
                    <div class="mb-4">
                        <label for="signupName" class="block text-sm font-medium text-slate-700">Full Name</label>
                        <input type="text" id="signupName" name="signupName" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm" required>
                    </div>
                    <div class="mb-4">
                        <label for="signupGender" class="block text-sm font-medium text-slate-700">Gender</label>
                        <select id="signupGender" name="signupGender" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm" required>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    <div class="mb-6">
                        <label for="signupHouse" class="block text-sm font-medium text-slate-700">Team / House</label>
                        <select id="signupHouse" name="signupHouse" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md text-sm shadow-sm" required>
                            <option value="Mason">Mason</option>
                            <option value="Sheppard">Sheppard</option>
                            <option value="Sumner">Sumner</option>
                            <option value="Taylor">Taylor</option>
                        </select>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" class="cancel-btn bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 transition">Cancel</button>
                        <button type="submit" class="bg-teal-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-teal-700 transition">Sign Up</button>
                    </div>
                </form>
            </div>
             <div id="signupMessageContainer" class="hidden text-center">
                <p id="signupMessage" class="text-lg font-medium text-slate-800"></p>
                <button type="button" class="cancel-btn mt-4 bg-slate-200 text-slate-800 font-semibold px-4 py-2 rounded-lg hover:bg-slate-300 transition">Close</button>
            </div>
        </div>
    </dialog>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc,
            updateDoc,
            onSnapshot,
            query,
            deleteDoc,
            writeBatch,
            getDocs,
            getDoc,
            where,
            enableIndexedDbPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =====================================================================================
        // ======================== IMPORTANT FIREBASE SETUP ===================================
        // =====================================================================================
       const firebaseConfig = {
          apiKey: "AIzaSyA80i1A49Rl6w-Zhu_WvWjxFI-mXTN8B2E",
          authDomain: "bidd-sport-v2.firebaseapp.com",
          projectId: "bidd-sport-v2",
          storageBucket: "bidd-sport-v2.firebasestorage.app",
          messagingSenderId: "155868171898",
          appId: "1:155868171898:web:67ec6c4025151ef608f5c3"
        };
        };
        const appId = "bidd-sports-v2";
        // =====================================================================================
        // ======================== END OF SETUP SECTION =======================================
        // =====================================================================================

        let app, auth, db;
        let userId;
        let currentMeetId = null;
        let currentEventId = null;
        let currentMeet = null;
        let currentMeetName = '';
        let currentEventName = '';
        let currentEvent = null;
        let currentParticipants = [];
        let currentSortOrder = 'placing'; // 'placing' or 'alphabetical'
        let currentGenderView = 'Male';
        let deleteContext = null; // { type: 'event'/'participant'/'meet', id: '...' }

        let meetsUnsubscribe = null;
        let eventsUnsubscribe = null;
        let resultsUnsubscribe = null;
        let parsedCsvData = null;
        
        const houseColors = {
            'Mason': { bg: 'bg-yellow-200', text: 'text-yellow-800', border: 'border-yellow-400' },
            'Sheppard': { bg: 'bg-green-200', text: 'text-green-800', border: 'border-green-400' },
            'Sumner': { bg: 'bg-red-200', text: 'text-red-800', border: 'border-red-400' },
            'Taylor': { bg: 'bg-blue-200', text: 'text-blue-800', border: 'border-blue-400' }
        };
        
        const loadingEl = document.getElementById('loading');
        const loadingMessage = document.getElementById('loading-message');
        const mainContentEl = document.getElementById('mainContent');
        
        const meetsView = document.getElementById('meetsView');
        const meetsGrid = document.getElementById('meetsGrid');
        const noMeetsMessage = document.getElementById('noMeetsMessage');
        const addMeetBtn = document.getElementById('addMeetBtn');
        const addMeetModal = document.getElementById('addMeetModal');
        const addMeetForm = document.getElementById('addMeetForm');
        const editMeetModal = document.getElementById('editMeetModal');
        const editMeetForm = document.getElementById('editMeetForm');
        const deleteMeetBtn = document.getElementById('deleteMeetBtn');

        const eventsView = document.getElementById('eventsView');
        const eventsGrid = document.getElementById('eventsGrid');
        const noEventsMessage = document.getElementById('noEventsMessage');
        const backToMeetsBtn = document.getElementById('backToMeetsBtn');
        const addEventBtn = document.getElementById('addEventBtn');
        const addEventModal = document.getElementById('addEventModal');
        const addEventForm = document.getElementById('addEventForm');
        const editEventModal = document.getElementById('editEventModal');
        const editEventForm = document.getElementById('editEventForm');
        
        const shareLinkBtn = document.getElementById('shareLinkBtn');
        const shareScorerLinkBtn = document.getElementById('shareScorerLinkBtn');
        const shareLinkModal = document.getElementById('shareLinkModal');
        const shareableLinkInput = document.getElementById('shareableLink');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const shareLinkDescription = document.getElementById('shareLinkDescription');

        const signupView = document.getElementById('signupView');
        const signupCompetitionName = document.getElementById('signupCompetitionName');
        const signupEventsGrid = document.getElementById('signupEventsGrid');
        const noSignupEventsMessage = document.getElementById('noSignupEventsMessage');
        const publicSignupModal = document.getElementById('publicSignupModal');
        const publicSignupForm = document.getElementById('publicSignupForm');
        const signupEventName = document.getElementById('signupEventName');
        const signupEventIdInput = document.getElementById('signupEventId');
        const signupFormContainer = document.getElementById('signupFormContainer');
        const signupMessageContainer = document.getElementById('signupMessageContainer');
        const signupMessage = document.getElementById('signupMessage');


        const resultsView = document.getElementById('resultsView');
        const resultsContainer = document.getElementById('resultsContainer');
        const resultsEventName = document.getElementById('resultsEventName');
        const resultsEventInfo = document.getElementById('resultsEventInfo');
        const resultsMaleRecordInfo = document.getElementById('resultsMaleRecordInfo');
        const resultsFemaleRecordInfo = document.getElementById('resultsFemaleRecordInfo');
        const resultsTableBody = document.getElementById('resultsTableBody');
        const noParticipantsMessage = document.getElementById('noParticipantsMessage');
        const backToEventsBtn = document.getElementById('backToEventsBtn');
        const addParticipantBtn = document.getElementById('addParticipantBtn');
        const addParticipantModal = document.getElementById('addParticipantModal');
        const addParticipantForm = document.getElementById('addParticipantForm');
        
        const editParticipantModal = document.getElementById('editParticipantModal');
        const editParticipantForm = document.getElementById('editParticipantForm');
        const editParticipantIdInput = document.getElementById('editParticipantId');
        const editAthleteNameInput = document.getElementById('editAthleteName');
        const editGenderSelect = document.getElementById('editGender');
        const editHouseGroupSelect = document.getElementById('editHouseGroup');

        const editResultModal = document.getElementById('editResultModal');
        const editResultForm = document.getElementById('editResultForm');
        const editResultAthleteName = document.getElementById('editResultAthleteName');
        const editResultParticipantId = document.getElementById('editResultParticipantId');

        const deleteEventBtn = document.getElementById('deleteEventBtn');
        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const deleteConfirmText = document.getElementById('deleteConfirmText');

        const uploadCsvBtn = document.getElementById('uploadCsvBtn');
        const csvFileInput = document.getElementById('csvFileInput');
        const csvUploadModal = document.getElementById('csvUploadModal');
        const confirmCsvImport = document.getElementById('confirmCsvImport');
        const csvFirstNameSelect = document.getElementById('csvFirstName');
        const csvSurnameSelect = document.getElementById('csvSurname');
        const csvGenderSelect = document.getElementById('csvGender');
        const csvHouseGroupSelect = document.getElementById('csvHouseGroup');
        const csvPreviewHead = document.getElementById('csvPreviewHead');
        const csvPreviewBody = document.getElementById('csvPreviewBody');
        const housePointsList = document.getElementById('housePointsList');
        const housePointsTitle = document.getElementById('housePointsTitle');
        const eventsTitle = document.getElementById('eventsTitle');
        const printHousePointsBtn = document.getElementById('printHousePointsBtn');
        const printResultsBtn = document.getElementById('printResultsBtn');
        const printQualifiersBtn = document.getElementById('printQualifiersBtn');
        const sortByNameBtn = document.getElementById('sortByNameBtn');
        const maleTab = document.getElementById('maleTab');
        const femaleTab = document.getElementById('femaleTab');

        let isScorerMode = false;

        function showView(view) {
            meetsView.classList.toggle('hidden', view !== 'meets');
            eventsView.classList.toggle('hidden', view !== 'events');
            resultsView.classList.toggle('hidden', view !== 'results');
            signupView.classList.add('hidden'); // Always hide admin views when showing public
        }
        function formatTime(seconds) {
            if (seconds === null || seconds === undefined || isNaN(seconds)) return 'N/A';
            const totalSeconds = parseFloat(seconds);
            const mins = Math.floor(totalSeconds / 60);
            const secs = totalSeconds % 60;
            const paddedMins = String(mins).padStart(2, '0');
            const paddedSecs = secs.toFixed(2).padStart(5, '0');
            return `${paddedMins}:${paddedSecs}`;
        }

        function isTimeBased(type) {
            return type === 'Time';
        }

        // --- MEET FUNCTIONS ---
        function renderMeets(meets) {
            meetsGrid.innerHTML = '';
            noMeetsMessage.classList.toggle('hidden', meets.length > 0);
            meets.forEach(meet => {
                const card = document.createElement('div');
                card.className = 'bg-white p-5 rounded-lg shadow-md hover:shadow-lg transition-shadow relative';
                
                const cardContent = document.createElement('div');
                cardContent.className = 'cursor-pointer';
                cardContent.innerHTML = `<h3 class="text-xl font-bold text-slate-800 truncate">${meet.name}</h3>`;
                cardContent.addEventListener('click', () => {
                    currentMeetId = meet.id;
                    currentMeetName = meet.name;
                    currentMeet = meet;
                    housePointsTitle.textContent = `Team Points: ${meet.name}`;
                    eventsTitle.textContent = `Events: ${meet.name}`;
                    showView('events');
                    fetchEvents(meet.id);
                });

                if (!isScorerMode) {
                    const editBtn = document.createElement('button');
                    editBtn.className = 'absolute top-2 right-2 p-1 rounded-full hover:bg-slate-200';
                    editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-500" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>`;
                    editBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        editMeetForm.elements.meetId.value = meet.id;
                        editMeetForm.elements.meetName.value = meet.name;
                        editMeetForm.elements.ageGroups.value = (meet.ageGroups || []).join('\n');
                        editMeetModal.showModal();
                    });
                    card.appendChild(editBtn);
                }

                card.appendChild(cardContent);
                meetsGrid.appendChild(card);
            });
        }
        async function fetchMeets() {
            if (meetsUnsubscribe) meetsUnsubscribe();
            const meetsCol = collection(db, 'artifacts', appId, 'public', 'data', 'meets');
            meetsUnsubscribe = onSnapshot(query(meetsCol), snapshot => {
                const meets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMeets(meets);
                loadingEl.classList.add('hidden');
                mainContentEl.classList.remove('hidden');
                showView('meets');
            }, error => {
                console.error("Firestore Error fetching meets:", error);
                loadingMessage.innerHTML = `<strong>Error:</strong> Could not fetch data. Please check your Firestore security rules. <br><small>${error.message}</small>`;
            });
        }
        addMeetForm.addEventListener('submit', (e) => {
             e.preventDefault();
             const formData = new FormData(e.target);
             const ageGroups = formData.get('ageGroups').split('\n').map(s => s.trim()).filter(Boolean);
             const newMeet = { name: formData.get('meetName'), ageGroups, createdAt: new Date() };
             const meetsCol = collection(db, 'artifacts', appId, 'public', 'data', 'meets');
             addDoc(meetsCol, newMeet).then(() => {
                e.target.reset();
                addMeetModal.close();
             }).catch(err => console.error("Error adding meet:", err));
        });
        
        async function handleUpdateMeet(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const meetId = formData.get('meetId');
            const ageGroups = formData.get('ageGroups').split('\n').map(s => s.trim()).filter(Boolean);
            const updatedMeet = {
                name: formData.get('meetName'),
                ageGroups
            };
            const meetDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'meets', meetId);
            try {
                await updateDoc(meetDocRef, updatedMeet);
                editMeetModal.close();
            } catch (error) {
                console.error("Error updating meet:", error);
            }
        }
        
        // --- EVENT FUNCTIONS ---
        let allEvents = [];
        function renderEvents(events) {
            eventsGrid.innerHTML = '';
            noEventsMessage.classList.toggle('hidden', events.length > 0);
            
            const groupedEvents = events.reduce((acc, event) => {
                const category = event.category || 'Other';
                if (!acc[category]) {
                    acc[category] = [];
                }
                acc[category].push(event);
                return acc;
            }, {});

            const categories = Object.keys(groupedEvents).sort();

            for (const category of categories) {
                const groupContainer = document.createElement('div');
                groupContainer.innerHTML = `<h3 class="text-xl font-semibold text-slate-600 mb-2 border-b pb-2">${category}</h3>`;
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
                
                groupedEvents[category].forEach(event => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-5 rounded-lg shadow-md hover:shadow-lg transition-shadow relative';
                    
                    const cardContent = document.createElement('div');
                    cardContent.className = 'cursor-pointer';
                    cardContent.innerHTML = `<h3 class="text-xl font-bold text-slate-800 truncate">${event.name}</h3><p class="text-slate-500 capitalize">${event.ageGroup}</p>`;
                    cardContent.addEventListener('click', () => {
                        currentEventId = event.id;
                        currentEventName = event.name;
                        currentEvent = event;
                        currentSortOrder = 'placing';
                        currentGenderView = 'Male';
                        updateTabs();
                        
                        resultsEventName.textContent = event.name;
                        resultsEventInfo.textContent = `Results in ${event.units}.`;
                        
                        let maleRecordText = 'Male Record: Not set';
                        if (event.maleRecord) {
                            const formattedRecord = isTimeBased(event.eventType) ? formatTime(event.maleRecord) + 's' : event.maleRecord + (event.units || '');
                            maleRecordText = `Male Record: ${formattedRecord}`;
                            if (event.maleRecordHolder) {
                                maleRecordText += ` (${event.maleRecordHolder}, ${event.maleRecordYear || ''})`;
                            }
                        }
                        resultsMaleRecordInfo.textContent = maleRecordText;

                        let femaleRecordText = 'Female Record: Not set';
                        if (event.femaleRecord) {
                            const formattedRecord = isTimeBased(event.eventType) ? formatTime(event.femaleRecord) + 's' : event.femaleRecord + (event.units || '');
                            femaleRecordText = `Female Record: ${formattedRecord}`;
                            if (event.femaleRecordHolder) {
                                femaleRecordText += ` (${event.femaleRecordHolder}, ${event.femaleRecordYear || ''})`;
                            }
                        }
                        resultsFemaleRecordInfo.textContent = femaleRecordText;

                        showView('results');
                        fetchResults(currentMeetId, event.id, event);
                    });

                    if (!isScorerMode) {
                        const editBtn = document.createElement('button');
                        editBtn.className = 'absolute top-2 right-2 p-1 rounded-full hover:bg-slate-200';
                        editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-500" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>`;
                        editBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            editEventForm.elements.eventId.value = event.id;
                            editEventForm.elements.eventName.value = event.name;
                            editEventForm.elements.eventType.value = event.eventType;
                            
                            const ageGroupSelect = editEventForm.elements.ageGroup;
                            ageGroupSelect.innerHTML = '';
                            currentMeet.ageGroups.forEach(ag => {
                                const option = new Option(ag, ag);
                                ageGroupSelect.add(option);
                            });
                            ageGroupSelect.value = event.ageGroup;

                            editEventForm.elements.eventUnits.value = event.units;
                            editEventForm.elements.maleEventRecord.value = event.maleRecord || '';
                            editEventForm.elements.maleRecordHolder.value = event.maleRecordHolder || '';
                            editEventForm.elements.maleRecordYear.value = event.maleRecordYear || '';
                            editEventForm.elements.femaleEventRecord.value = event.femaleRecord || '';
                            editEventForm.elements.femaleRecordHolder.value = event.femaleRecordHolder || '';
                            editEventForm.elements.femaleRecordYear.value = event.femaleRecordYear || '';
                            editEventModal.showModal();
                        });
                         card.appendChild(editBtn);
                    }
                    
                    card.appendChild(cardContent);
                    grid.appendChild(card);
                });
                eventsGrid.appendChild(groupContainer);
                eventsGrid.appendChild(grid);
            }
        }
        async function fetchEvents(meetId) {
            calculateAndRenderHousePoints(meetId);
            if (eventsUnsubscribe) eventsUnsubscribe();
            const eventsCol = collection(db, 'artifacts', appId, 'public', 'data', 'meets', meetId, 'events');
            eventsUnsubscribe = onSnapshot(query(eventsCol), snapshot => {
                allEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderEvents(allEvents);
            }, error => {
                console.error("Firestore Error fetching events:", error);
            });
        }
        addEventForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if(!currentMeetId) return;
            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'meets', currentMeetId, 'events');
            const dataBuilder = fd => ({ 
                name: fd.get('eventName'), 
                eventType: fd.get('eventType'), 
                ageGroup: fd.get('ageGroup'),
                category: fd.get('category'),
                units: fd.get('eventUnits'),
                maleRecord: parseFloat(fd.get('maleEventRecord')) || null,
                maleRecordHolder: fd.get('maleRecordHolder') || null,
                maleRecordYear: parseInt(fd.get('maleRecordYear')) || null,
                femaleRecord: parseFloat(fd.get('femaleEventRecord')) || null,
                femaleRecordHolder: fd.get('femaleRecordHolder') || null,
                femaleRecordYear: parseInt(fd.get('femaleRecordYear')) || null
            });
            handleFormSubmit(e, addEventModal, collectionRef, dataBuilder);
        });
        
        async function handleUpdateEvent(e) {
            e.preventDefault();
            if(!currentMeetId) return;
            const formData = new FormData(e.target);
            const eventId = formData.get('eventId');
            const updatedEvent = {
                name: formData.get('eventName'),
                eventType: formData.get('eventType'),
                ageGroup: formData.get('ageGroup'),
                category: formData.get('category'),
                units: formData.get('eventUnits'),
                maleRecord: parseFloat(formData.get('maleEventRecord')) || null,
                maleRecordHolder: formData.get('maleRecordHolder') || null,
                maleRecordYear: parseInt(formData.get('maleRecordYear')) || null,
                femaleRecord: parseFloat(formData.get('femaleEventRecord')) || null,
                femaleRecordHolder: formData.get('femaleRecordHolder') || null,
                femaleRecordYear: parseInt(formData.get('femaleRecordYear')) || null
            };
            const eventDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'meets', currentMeetId, 'events', eventId);
            try {
                await updateDoc(eventDocRef, updatedEvent);
                editEventModal.close();
            } catch (error) {
                console.error("Error updating event:", error);
            }
        }

        // --- PARTICIPANT/RESULT FUNCTIONS ---
        function renderParticipants(participants, event) {
            currentParticipants = participants;
            
            const participantsOfGender = participants.filter(p => p.gender === currentGenderView);
            
            const eventType = event.eventType;
            const eventRecord = currentGenderView === 'Male' ? event.maleRecord : event.femaleRecord;
            
            const withResults = participantsOfGender.filter(p => p.result !== null && p.result !== undefined);
            const withoutResults = participantsOfGender.filter(p => p.result === null || p.result === undefined);
            
            withResults.sort((a, b) => isTimeBased(eventType) ? a.result - b.result : b.result - a.result);
            
            if (withResults.length > 0) {
                 withResults.forEach(p => p.isRecord = false);
                const topResult = withResults[0].result;
                let isNewRecord = (eventRecord !== null && ((isTimeBased(eventType) && topResult < eventRecord) || (!isTimeBased(eventType) && topResult > eventRecord))) || (eventRecord === null && topResult !== null);
                if (isNewRecord) {
                    withResults.forEach(p => { if(p.result === topResult) p.isRecord = true; });
                }
                withResults[0].placing = 1;
                for (let i = 1; i < withResults.length; i++) {
                    if (withResults[i].result === withResults[i - 1].result) {
                        withResults[i].placing = withResults[i - 1].placing;
                    } else {
                        withResults[i].placing = i + 1;
                    }
                }
            }

            let displayList = [...withResults, ...withoutResults];

            if (currentSortOrder === 'alphabetical') {
                displayList.sort((a, b) => {
                    const surnameA = (a.athleteName.split(' ').pop() || '').toLowerCase();
                    const surnameB = (b.athleteName.split(' ').pop() || '').toLowerCase();
                    return surnameA.localeCompare(surnameB);
                });
            }

            resultsTableBody.innerHTML = '';
            const hasParticipants = participantsOfGender.length > 0;
            noParticipantsMessage.classList.toggle('hidden', hasParticipants);
            resultsContainer.querySelector('table').classList.toggle('hidden', !hasParticipants);
            
            displayList.forEach(p => {
                const row = createParticipantRow(p, p.placing || '-', eventType);
                resultsTableBody.appendChild(row);
            });
        }
        function createParticipantRow(participant, rank, eventType) {
            const row = document.createElement('tr');
            row.className = 'border-b border-slate-200 hover:bg-slate-50';
            const hasResult = participant.result !== null && participant.result !== undefined;
            let displayResult = hasResult ? (isTimeBased(eventType) ? formatTime(participant.result) : participant.result) : 'N/A';
            
            if (participant.isRecord) {
                displayResult += ` <span class="ml-2 text-amber-500 font-bold">🏆 New Record!</span>`;
            }

            const houseColor = houseColors[participant.houseGroup] || { bg: 'bg-gray-200', text: 'text-gray-800' };
            const houseBadge = `<span class="px-2 py-1 text-xs font-semibold leading-tight rounded-full ${houseColor.bg} ${houseColor.text}">${participant.houseGroup}</span>`;
            
            const participationCheckbox = `
                <td class="p-3 text-center">
                    <input type="checkbox" data-id="${participant.id}" class="participation-check h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${participant.participated ? 'checked' : ''}>
                </td>
            `;

            row.innerHTML = `<td class="p-3 font-medium">${rank}</td><td class="p-3">${participant.athleteName}</td><td class="p-3">${houseBadge}</td>${participationCheckbox}<td class="p-3">${displayResult}</td><td class="p-3"></td>`;
            
            const actionsCell = row.cells[5];
            actionsCell.className = 'p-3 flex items-center gap-2';
            
            const resultButton = document.createElement('button');
            resultButton.textContent = hasResult ? 'Edit Result' : 'Add Result';
            resultButton.className = hasResult ? 'bg-yellow-500 text-white font-semibold px-3 py-1 text-sm rounded-md shadow hover:bg-yellow-600 transition' : 'bg-indigo-500 text-white font-semibold px-3 py-1 text-sm rounded-md shadow hover:bg-indigo-600 transition';
            resultButton.addEventListener('click', () => {
                editResultAthleteName.textContent = participant.athleteName;
                editResultParticipantId.value = participant.id;
                editResultForm.resultValue.value = participant.result || '';
                editResultModal.showModal();
            });
            actionsCell.appendChild(resultButton);

            const editButton = document.createElement('button');
            editButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>`;
            editButton.className = 'text-slate-500 hover:text-indigo-600';
            editButton.title = "Edit Participant";
            editButton.addEventListener('click', () => {
                editParticipantIdInput.value = participant.id;
                editAthleteNameInput.value = participant.athleteName;
                editGenderSelect.value = participant.gender;
                editHouseGroupSelect.value = participant.houseGroup;
                editParticipantModal.showModal();
            });
            actionsCell.appendChild(editButton);

            if (hasResult) {
                const clearButton = document.createElement('button');
                clearButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>`;
                clearButton.className = 'text-slate-500 hover:text-red-600';
                clearButton.title = "Clear Result";
                clearButton.addEventListener('click', () => handleClearResult(participant.id));
                actionsCell.appendChild(clearButton);
            }

            const deleteParticipantBtn = document.createElement('button');
            deleteParticipantBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`;
            deleteParticipantBtn.className = 'text-slate-500 hover:text-red-600';
            deleteParticipantBtn.title = "Delete Participant";
            deleteParticipantBtn.addEventListener('click', () => {
                deleteContext = { type: 'participant', id: participant.id };
                deleteConfirmText.textContent = `This will permanently delete ${participant.athleteName} from this event. This action cannot be undone.`;
                deleteConfirmModal.showModal();
            });
            actionsCell.appendChild(deleteParticipantBtn);

            row.querySelector('.participation-check').addEventListener('change', (e) => handleToggleParticipation(e.target.dataset.id, e.target.checked));

            return row;
        }
        async function fetchResults(meetId, eventId, event) {
            if (resultsUnsubscribe) resultsUnsubscribe();
            const resultsCol = collection(db, 'artifacts', appId, 'public', 'data', 'meets', meetId, 'events', eventId, 'results');
            resultsUnsubscribe = onSnapshot(query(resultsCol), snapshot => {
                const participants = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderParticipants(participants, event);
            }, error => console.error(`Error fetching results for event ${eventId}:`, error));
        }
        addParticipantForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if(!currentMeetId || !currentEventId) return;
            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'meets', currentMeetId, 'events', currentEventId, 'results');
            const dataBuilder = fd => ({ 
                athleteName: fd.get('athleteName'), 
                houseGroup: fd.get('houseGroup'), 
                gender: fd.get('gender'),
                result: null, 
                participated: false, 
                createdAt: new Date() 
            });
            handleFormSubmit(e, addParticipantModal, collectionRef, dataBuilder);
        });

        // --- GENERAL HANDLERS ---
        async function handleFormSubmit(e, modal, collectionRef, dataBuilder) {
            if(!collectionRef) return;
            try {
                await addDoc(collectionRef, dataBuilder(new FormData(e.target)));
                e.target.reset();
                modal.close();
            } catch (error) {
                console.error("Error adding document: ", error);
            }
        }

        async function handleUpdateParticipant(e) {
            e.preventDefault();
            const participantId = editParticipantIdInput.value;
            const newName = editAthleteNameInput.value;
            const newHouse = editHouseGroupSelect.value;
            const newGender = editGenderSelect.value;

            if (!currentMeetId || !currentEventId || !participantId) return;
            try {
                const participantDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'meets', currentMeetId, 'events', currentEventId, 'results', participantId);
                await updateDoc(participantDocRef, { 
                    athleteName: newName,
                    houseGroup: newHouse,
                    gender: newGender
                });
                editParticipantForm.reset();
                editParticipantModal.close();
            } catch (error) {
                console.error("Error updating participant:", error);
            }
        }
        
        async function handleClearResult(participantId) {
            if (!currentMeetId || !currentEventId || !participantId) return;
            try {
                const participantDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'meets', currentMeetId, 'events', currentEventId, 'results', participantId);
                await updateDoc(participantDocRef, { result: null });
            } catch (error) {
                console.error("Error clearing result:", error);
            }
        }

         async function handleToggleParticipation(participantId, isChecked) {
            if (!currentMeetId || !currentEventId || !participantId) return;
            try {
                const participantDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'meets', currentMeetId, 'events', currentEventId, 'results', participantId);
                await updateDoc(participantDocRef, { participated: isChecked });
            } catch (error) {
                console.error("Error updating participation:", error);
            }
        }


        async function handleUpdateResult(e) {
            e.preventDefault();
            const participantId = editResultParticipantId.value;
            const resultValue = parseFloat(editResultForm.resultValue.value);
            if (!currentMeetId || !currentEventId || !participantId) return;
            try {
                const participantDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'meets', currentMeetId, 'events', currentEventId, 'results', participantId);
                await updateDoc(participantDocRef, { result: resultValue, participated: true });

                const eventDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'meets', currentMeetId, 'events', currentEventId);
                const resultsColRef = collection(eventDocRef, 'results');
                const resultsSnapshot = await getDocs(resultsColRef);
                const participants = resultsSnapshot.docs.map(d => ({id: d.id, ...d.data()}));
                const withResults = participants.filter(p => p.result !== null && p.result !== undefined);
                
                if (withResults.length > 0) {
                    withResults.sort((a, b) => isTimeBased(currentEvent.eventType) ? a.result - b.result : b.result - a.result);
                    const topResult = withResults[0].result;

                    const recordBreaker = withResults.find(p => p.result === topResult);
                    const gender = recordBreaker.gender;
                    const eventRecord = gender === 'Male' ? currentEvent.maleRecord : currentEvent.femaleRecord;

                    const isNewRecord = (eventRecord !== null && ((isTimeBased(currentEvent.eventType) && topResult < eventRecord) || (!isTimeBased(currentEvent.eventType) && topResult > eventRecord))) || (eventRecord === null && topResult !== null);
                    
                    if (isNewRecord) {
                        if (gender === 'Male') {
                           await updateDoc(eventDocRef, { maleRecord: topResult, maleRecordHolder: recordBreaker.athleteName, maleRecordYear: new Date().getFullYear() });
                        } else {
                           await updateDoc(eventDocRef, { femaleRecord: topResult, femaleRecordHolder: recordBreaker.athleteName, femaleRecordYear: new Date().getFullYear() });
                        }
                    }
                }

                editResultForm.reset();
                editResultModal.close();
            } catch (error) {
                console.error("Error updating result:", error);
            }
        }
        
        async function handleDelete() {
            if (!deleteContext || !currentMeetId) return;
            const { type, id } = deleteContext;

            if(type === 'event' && currentEventId) {
                 try {
                    const eventDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'meets', currentMeetId, 'events', currentEventId);
                    const resultsColRef = collection(eventDocRef, 'results');
                    const resultsSnapshot = await getDocs(resultsColRef);
                    const batch = writeBatch(db);
                    resultsSnapshot.docs.forEach(d => batch.delete(d.ref));
                    await batch.commit();
                    await deleteDoc(eventDocRef);
                    showView('events');
                    currentEventId = null;
                } catch(error) {
                    console.error("Error deleting event:", error);
                    alert("Could not delete event. Please check connection.");
                }
            } else if (type === 'participant' && currentEventId) {
                try {
                    const participantDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'meets', currentMeetId, 'events', currentEventId, 'results', id);
                    await deleteDoc(participantDocRef);
                } catch(error) {
                    console.error("Error deleting participant:", error);
                    alert("Could not delete participant. Please check connection.");
                }
            }
            deleteConfirmModal.close();
            deleteContext = null;
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    parsedCsvData = results;
                    const headers = results.meta.fields;
                    [csvFirstNameSelect, csvSurnameSelect, csvGenderSelect, csvHouseGroupSelect].forEach(sel => sel.innerHTML = '');
                    headers.forEach(header => {
                        [csvFirstNameSelect, csvSurnameSelect, csvGenderSelect, csvHouseGroupSelect].forEach(sel => sel.add(new Option(header, header)));
                    });
                    const lowerCaseHeaders = headers.map(h => h.toLowerCase());
                    const firstNameIndex = lowerCaseHeaders.findIndex(h => h.includes('first') || h.includes('given'));
                    const surnameIndex = lowerCaseHeaders.findIndex(h => h.includes('last') || h.includes('surname'));
                    const genderIndex = lowerCaseHeaders.findIndex(h => h.includes('gender') || h.includes('sex'));
                    const houseIndex = lowerCaseHeaders.findIndex(h => h.includes('house') || h.includes('team'));
                    if (firstNameIndex > -1) csvFirstNameSelect.selectedIndex = firstNameIndex;
                    if (surnameIndex > -1) csvSurnameSelect.selectedIndex = surnameIndex;
                    if (genderIndex > -1) csvGenderSelect.selectedIndex = genderIndex;
                    if (houseIndex > -1) csvHouseGroupSelect.selectedIndex = houseIndex;
                    csvPreviewHead.innerHTML = `<tr>${headers.map(h => `<th class="p-2 font-semibold text-sm">${h}</th>`).join('')}</tr>`;
                    csvPreviewBody.innerHTML = results.data.slice(0, 5).map(row => `<tr class="border-t border-slate-200">${headers.map(h => `<td class="p-2 text-sm">${row[h] || ''}</td>`).join('')}</tr>`).join('');
                    csvUploadModal.showModal();
                },
                error: error => console.error("Error parsing CSV:", error)
            });
            csvFileInput.value = '';
        }
        async function handleConfirmCsvImport() {
            if (!parsedCsvData || !currentMeetId) return;

            const importBtn = document.getElementById('confirmCsvImport');
            importBtn.disabled = true;
            importBtn.textContent = 'Importing...';

            try {
                let count = 0;
                if (deleteContext.type === 'csv-all') {
                    // Import to all matching events by age group
                    const firstNameColumn = csvFirstNameSelect.value;
                    const surnameColumn = csvSurnameSelect.value;
                    const genderColumn = csvGenderSelect.value;
                    const ageGroupColumn = csvAgeGroupSelect.value;
                    const houseColumn = csvHouseGroupSelect.value;
                    
                    if (!firstNameColumn || !surnameColumn || !houseColumn || !genderColumn || !ageGroupColumn) {
                        alert("Please map all columns: First Name, Surname, Gender, Age Group, and Team/House.");
                        importBtn.disabled = false;
                        importBtn.textContent = 'Confirm & Import';
                        return;
                    }
                    
                    const eventsSnapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'meets', currentMeetId, 'events'));
                    const eventsByAgeGroup = {};
                    eventsSnapshot.docs.forEach(doc => {
                        const event = { id: doc.id, ...doc.data() };
                        if (!eventsByAgeGroup[event.ageGroup]) {
                            eventsByAgeGroup[event.ageGroup] = [];
                        }
                        eventsByAgeGroup[event.ageGroup].push(event.id);
                    });

                    const batch = writeBatch(db);
                    for (const row of parsedCsvData.data) {
                        const firstName = row[firstNameColumn];
                        const surname = row[surnameColumn];
                        const genderRaw = row[genderColumn];
                        const ageGroup = row[ageGroupColumn];
                        const houseGroup = row[houseColumn];

                        if (firstName && surname && houseGroup && genderRaw && ageGroup) {
                            const athleteName = `${firstName.trim()} ${surname.trim()}`;
                            const gender = genderRaw.trim().toLowerCase().startsWith('m') ? 'Male' : 'Female';
                            const matchingEventIds = eventsByAgeGroup[ageGroup.trim()] || [];
                            
                            for (const eventId of matchingEventIds) {
                                const resultsCol = collection(db, 'artifacts', appId, 'public', 'data', 'meets', currentMeetId, 'events', eventId, 'results');
                                batch.set(doc(resultsCol), { athleteName, houseGroup: houseGroup.trim(), gender: gender, result: null, participated: false, createdAt: new Date() });
                            }
                            count++;
                        }
                    }
                    await batch.commit();
                    alert(`${count} participants processed and added to matching events!`);
                } 
                csvUploadModal.close();
                parsedCsvData = null;
            } catch (error) {
                console.error("Error importing participants:", error);
                alert(`Import failed: ${error.message}`);
            } finally {
                importBtn.disabled = false;
                importBtn.textContent = 'Confirm & Import';
            }
        }
        async function calculateAndRenderHousePoints(meetId) {
            if(!meetId) return;
            const housePoints = { Mason: 0, Sheppard: 0, Sumner: 0, Taylor: 0 };
            const pointsMap = { 1: 5, 2: 3, 3: 1 };
            const participationPoint = 1;

            const eventsSnapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'meets', meetId, 'events'));

            for (const eventDoc of eventsSnapshot.docs) {
                const event = eventDoc.data();
                const resultsSnapshot = await getDocs(collection(eventDoc.ref, 'results'));
                const participants = resultsSnapshot.docs.map(d => d.data());
                
                participants.forEach(p => {
                    if ((p.participated || (p.result !== null && p.result !== undefined)) && housePoints.hasOwnProperty(p.houseGroup)) {
                        housePoints[p.houseGroup] += participationPoint;
                    }
                });

                const withResults = participants.filter(p => p.result !== null && p.result !== undefined);
                if(withResults.length === 0) continue;
                
                // Process each gender separately for placings
                ['Male', 'Female'].forEach(gender => {
                    const genderResults = withResults.filter(p => p.gender === gender);
                    if (genderResults.length > 0) {
                        genderResults.sort((a, b) => isTimeBased(event.eventType) ? a.result - b.result : b.result - a.result);
                        genderResults[0].placing = 1;
                        for (let i = 1; i < genderResults.length; i++) {
                            if (genderResults[i].result === genderResults[i - 1].result) {
                                genderResults[i].placing = genderResults[i - 1].placing;
                            } else {
                                genderResults[i].placing = i + 1;
                            }
                        }
                        genderResults.forEach(p => {
                            if (pointsMap[p.placing] && housePoints.hasOwnProperty(p.houseGroup)) {
                                housePoints[p.houseGroup] += pointsMap[p.placing];
                            }
                        });
                    }
                });
            }

            const sortedHouses = Object.entries(housePoints).sort((a, b) => b[1] - a[1]);
            const maxScore = sortedHouses.length > 0 ? sortedHouses[0][1] : 0;

            housePointsList.innerHTML = sortedHouses.map(([name, score]) => {
                const houseColor = houseColors[name] || { bg: 'bg-gray-400' };
                const percentage = maxScore > 0 ? (score / maxScore) * 100 : 0;
                return `
                    <li>
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold text-slate-800">${name}</span>
                            <span class="font-bold text-xl text-indigo-600">${score}</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2.5">
                            <div class="h-2.5 rounded-full ${houseColor.bg.replace('200', '400')}" style="width: ${percentage}%"></div>
                        </div>
                    </li>
                `;
            }).join('');
        }
        
        // --- PDF Generation ---
        function generateResultsPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(`Results for: ${currentEventName} (${currentGenderView})`, 14, 16);
            doc.text(`Competition: ${currentMeetName}`, 14, 22);
            
            const tableData = [];
            const rows = resultsTableBody.querySelectorAll('tr');
            rows.forEach(row => {
                const rowData = [];
                row.querySelectorAll('td').forEach((cell, index) => {
                    if (index < 5) { 
                        if (index === 3) { // Participation column
                           rowData.push(cell.querySelector('input').checked ? 'Yes' : 'No');
                        } else {
                           rowData.push(cell.innerText);
                        }
                    }
                });
                tableData.push(rowData);
            });

            doc.autoTable({
                head: [['Placing', 'Participant Name', 'Team/House', 'Participated', 'Result']],
                body: tableData,
                startY: 30
            });
            doc.save(`results_${currentEventName.replace(/ /g, '_')}_${currentGenderView}.pdf`);
        }

         function generateQualifiersPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(`Qualifiers for: ${currentEventName}`, 14, 16);
            doc.text(`Competition: ${currentMeetName}`, 14, 22);
            
            let tableData = [];
            let startY = 30;

            ['Male', 'Female'].forEach(gender => {
                const participantsOfGender = currentParticipants.filter(p => p.gender === gender);
                const withResults = participantsOfGender.filter(p => p.result !== null && p.result !== undefined);
                if(withResults.length > 0) {
                     withResults.sort((a, b) => isTimeBased(currentEvent.eventType) ? a.result - b.result : b.result - a.result);
                     
                     if (withResults.length > 0) {
                        withResults[0].placing = 1;
                        for (let i = 1; i < withResults.length; i++) {
                            if (withResults[i].result === withResults[i - 1].result) {
                                withResults[i].placing = withResults[i - 1].placing;
                            } else {
                                withResults[i].placing = i + 1;
                            }
                        }
                    }

                     const qualifiers = withResults.filter(p => p.placing <= 3);
                     if (qualifiers.length > 0) {
                        doc.text(`${gender} Qualifiers`, 14, startY);
                        tableData = qualifiers.map(p => [p.placing, p.athleteName, p.houseGroup, isTimeBased(currentEvent.eventType) ? formatTime(p.result) : p.result]);
                        doc.autoTable({
                            head: [['Placing', 'Participant Name', 'Team/House', 'Result']],
                            body: tableData,
                            startY: startY + 6
                        });
                        startY = doc.lastAutoTable.finalY + 10;
                     }
                }
            });
            
            doc.save(`qualifiers_${currentEventName.replace(/ /g, '_')}.pdf`);
        }
        
        function generateHousePointsPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(`Team Points Summary`, 14, 16);
             doc.text(`Competition: ${currentMeetName}`, 14, 22);

            const tableData = [];
            const items = housePointsList.querySelectorAll('li');
            items.forEach(item => {
                const name = item.querySelector('span:first-child').innerText;
                const score = item.querySelector('span:last-child').innerText;
                tableData.push([name, score]);
            });

            doc.autoTable({
                head: [['Team/House', 'Total Points']],
                body: tableData,
                startY: 30
            });
            doc.save(`house_points_${currentMeetName.replace(/ /g, '_')}.pdf`);
        }
        
        // --- SIGN UP PAGE ---
        async function fetchAndRenderSignupPage(meetId) {
            loadingEl.classList.add('hidden');
            mainContentEl.classList.add('hidden');
            signupView.classList.remove('hidden');

            const meetDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'meets', meetId);
            const meetDoc = await getDoc(meetDocRef);
            if(meetDoc.exists()) {
                const meetData = meetDoc.data();
                currentMeetName = meetData.name;
                signupCompetitionName.textContent = `Sign Up for: ${meetData.name}`;

                const eventsCol = collection(meetDocRef, 'events');
                const eventsSnapshot = await getDocs(eventsCol);
                const events = eventsSnapshot.docs.map(d => ({id: d.id, ...d.data()}));
                renderSignupEvents(events);

            } else {
                 noSignupEventsMessage.classList.remove('hidden');
            }
        }
        
        function renderSignupEvents(events) {
            signupEventsGrid.innerHTML = '';
            noSignupEventsMessage.classList.toggle('hidden', events.length > 0);
            events.forEach(event => {
                const card = document.createElement('div');
                card.className = 'bg-white p-5 rounded-lg shadow-md';
                card.innerHTML = `
                    <h3 class="text-xl font-bold text-slate-800 truncate">${event.name}</h3>
                    <p class="text-slate-500 capitalize">${event.eventType} Event</p>
                    <button data-event-id="${event.id}" data-event-name="${event.name}" class="signup-btn mt-4 w-full bg-teal-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-teal-700 transition duration-200">Sign Up</button>
                `;
                signupEventsGrid.appendChild(card);
            });

            document.querySelectorAll('.signup-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    signupEventName.textContent = `Sign Up for: ${btn.dataset.eventName}`;
                    signupEventIdInput.value = btn.dataset.eventId;
                    signupFormContainer.classList.remove('hidden');
                    signupMessageContainer.classList.add('hidden');
                    publicSignupForm.reset();
                    publicSignupModal.showModal();
                });
            });
        }
        
        async function handlePublicSignup(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const eventId = formData.get('eventId');
            const participantName = formData.get('signupName').trim();
            const houseGroup = formData.get('signupHouse');
            const gender = formData.get('signupGender');
            
            const resultsCol = collection(db, 'artifacts', appId, 'public', 'data', 'meets', currentMeetId, 'events', eventId, 'results');
            
            // Check for duplicates
            const q = query(resultsCol, where("athleteName", "==", participantName));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                signupMessage.textContent = 'You are already signed up for this event.';
            } else {
                await addDoc(resultsCol, {
                    athleteName: participantName,
                    houseGroup: houseGroup,
                    gender: gender,
                    result: null,
                    participated: false,
                    createdAt: new Date()
                });
                signupMessage.textContent = 'Successfully signed up!';
            }
            signupFormContainer.classList.add('hidden');
            signupMessageContainer.classList.remove('hidden');
        }


        // --- NAVIGATION AND INIT ---
        addMeetBtn.addEventListener('click', () => addMeetModal.showModal());
        addEventBtn.addEventListener('click', () => {
            const ageGroupSelect = addEventForm.elements.ageGroup;
            ageGroupSelect.innerHTML = '';
            (currentMeet.ageGroups || []).forEach(ag => {
                const option = new Option(ag, ag);
                ageGroupSelect.add(option);
            });
            addEventModal.showModal()
        });
        addParticipantBtn.addEventListener('click', () => addParticipantModal.showModal());
        editResultForm.addEventListener('submit', handleUpdateResult);
        editParticipantForm.addEventListener('submit', handleUpdateParticipant);
        editEventForm.addEventListener('submit', handleUpdateEvent);
        publicSignupForm.addEventListener('submit', handlePublicSignup);
        
        backToMeetsBtn.addEventListener('click', () => {
             if (eventsUnsubscribe) { eventsUnsubscribe(); eventsUnsubscribe = null; }
            currentMeetId = null;
            showView('meets');
        });
        backToEventsBtn.addEventListener('click', async () => {
            if (resultsUnsubscribe) { resultsUnsubscribe(); resultsUnsubscribe = null; }
            currentEventId = null;
            showView('events');
            await calculateAndRenderHousePoints(currentMeetId);
        });

        shareLinkBtn.addEventListener('click', () => {
            const url = `${window.location.origin}${window.location.pathname}?signup=${currentMeetId}`;
            shareLinkDescription.textContent = 'Share this link with participants to allow them to sign up for events in this competition.';
            shareableLinkInput.value = url;
            shareLinkModal.showModal();
        });
         shareScorerLinkBtn.addEventListener('click', () => {
            const url = `${window.location.origin}${window.location.pathname}?scorer=${currentMeetId}`;
            shareLinkDescription.textContent = 'Share this link with users who need to record results for this competition.';
            shareableLinkInput.value = url;
            shareLinkModal.showModal();
        });

        copyLinkBtn.addEventListener('click', () => {
            shareableLinkInput.select();
            document.execCommand('copy');
            copyLinkBtn.textContent = 'Copied!';
            setTimeout(() => { copyLinkBtn.textContent = 'Copy Link'; }, 2000);
        });


        deleteEventBtn.addEventListener('click', () => {
            deleteContext = { type: 'event' };
            deleteConfirmText.textContent = `This will permanently delete the event "${currentEventName}" and all its results. This action cannot be undone.`
            deleteConfirmModal.showModal();
        });
        deleteMeetBtn.addEventListener('click', () => {
            const meetId = editMeetForm.elements.meetId.value;
            const meetName = editMeetForm.elements.meetName.value;
            deleteContext = { type: 'meet', id: meetId };
            deleteConfirmText.textContent = `This will permanently delete the competition "${meetName}" and ALL of its events and results. This action cannot be undone.`;
            deleteConfirmModal.showModal();
        });

        confirmDeleteBtn.addEventListener('click', handleDelete);
        uploadCsvBtn.addEventListener('click', () => { 
            deleteContext = { type: 'csv-single' };
            csvFileInput.click();
        });
        uploadCsvEventsBtn.addEventListener('click', () => { 
            deleteContext = { type: 'csv-all' };
            csvFileInput.click();
        });

        csvFileInput.addEventListener('change', handleFileSelect);
        confirmCsvImport.addEventListener('click', handleConfirmCsvImport);
        document.querySelectorAll('.cancel-btn').forEach(btn => btn.addEventListener('click', () => btn.closest('dialog').close()));
        
        printHousePointsBtn.addEventListener('click', generateHousePointsPdf);
        printResultsBtn.addEventListener('click', generateResultsPdf);
        printQualifiersBtn.addEventListener('click', generateQualifiersPdf);
        
        sortByNameBtn.addEventListener('click', () => {
            currentSortOrder = currentSortOrder === 'placing' ? 'alphabetical' : 'placing';
            renderParticipants(currentParticipants, currentEvent);
        });
        
        eventSearchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredEvents = allEvents.filter(event => event.name.toLowerCase().includes(searchTerm));
            renderEvents(filteredEvents);
        });

        function updateTabs() {
            if(currentGenderView === 'Male') {
                maleTab.classList.add('tab-active');
                femaleTab.classList.remove('tab-active');
            } else {
                femaleTab.classList.add('tab-active');
                maleTab.classList.remove('tab-active');
            }
        }

        maleTab.addEventListener('click', () => {
            currentGenderView = 'Male';
            updateTabs();
            renderParticipants(currentParticipants, currentEvent);
        });
        femaleTab.addEventListener('click', () => {
            currentGenderView = 'Female';
            updateTabs();
            renderParticipants(currentParticipants, currentEvent);
        });

        function enablePrintButtons() {
            printHousePointsBtn.disabled = false;
            printHousePointsBtn.textContent = 'Print Points';
            printResultsBtn.disabled = false;
            printResultsBtn.textContent = 'Print Results';
            printQualifiersBtn.disabled = false;
            printQualifiersBtn.textContent = 'Export Qualifiers';
        }
        
        function setupScorerMode() {
            isScorerMode = true;
            document.getElementById('addMeetBtn').classList.add('hidden');
            document.querySelectorAll('#meetsGrid button').forEach(btn => btn.classList.add('hidden'));
            document.getElementById('housePointsContainer').classList.add('hidden');
            document.getElementById('shareLinkBtn').classList.add('hidden');
            document.getElementById('shareScorerLinkBtn').classList.add('hidden');
            document.getElementById('addEventBtn').classList.add('hidden');
            document.getElementById('uploadCsvEventsBtn').classList.add('hidden');
            document.getElementById('deleteEventBtn').classList.add('hidden');
            document.getElementById('uploadCsvBtn').classList.add('hidden');
            document.getElementById('addParticipantBtn').classList.add('hidden');
            document.querySelectorAll('.edit-participant-btn, .delete-participant-btn').forEach(btn => btn.classList.add('hidden'));
        }

        async function init() {
            console.log("BIDD SPORTS Initializing...");
            const urlParams = new URLSearchParams(window.location.search);
            const signupMeetId = urlParams.get('signup');
            const scorerMeetId = urlParams.get('scorer');

            const pdfLibraryCheck = setInterval(() => {
                if (window.pdfLibrariesLoaded) {
                    enablePrintButtons();
                    clearInterval(pdfLibraryCheck);
                }
            }, 100);

            if (!firebaseConfig || !firebaseConfig.apiKey) {
                loadingMessage.innerHTML = '<strong>Configuration Incomplete.</strong><br>Firebase config is missing from the HTML file.';
                loadingEl.querySelector('.loader').classList.add('hidden');
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        if (signupMeetId) {
                            currentMeetId = signupMeetId;
                            await fetchAndRenderSignupPage(signupMeetId);
                        } else if(scorerMeetId) {
                            isScorerMode = true;
                            currentMeetId = scorerMeetId;
                            loadingEl.classList.add('hidden');
                            mainContentEl.classList.remove('hidden');
                            showView('events');
                            fetchEvents(scorerMeetId);
                            setupScorerMode();
                        }
                        else {
                            await fetchMeets();
                        }
                    } else {
                        signInAnonymously(auth).catch((error) => {
                             console.error("Anonymous sign-in failed:", error);
                             loadingMessage.innerHTML = `<strong>Authentication Failed.</strong><br>Please check your Firebase Authentication settings and browser console for errors.<br><small>${error.message}</small>`;
                             loadingEl.querySelector('.loader').classList.add('hidden');
                        });
                    }
                });

                await enableIndexedDbPersistence(db).catch(err => console.warn("Offline persistence not available:", err.code));
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                loadingMessage.innerHTML = `<strong>Connection Error.</strong><br>Could not connect to the database. Please check your Firebase project settings and console for details.<br><small>${error.message}</small>`;
                loadingEl.querySelector('.loader').classList.add('hidden');
            }
        }
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js').then(reg => {
                    console.log('Service worker registered successfully:', reg);
                }).catch(err => {
                    console.log('Service worker registration failed: ', err);
                });
            });
        }

        init();
    </script>
</body>
</html>


